<?xml version="1.0" encoding="UTF-8"?>
<PlusConfiguration version="2.3">
   <DataCollection StartupDelaySec="1.0">
      <DeviceSet Name="Kidney simulator" Description="US configurations with three vessels" />
      <!-- Optical marker tracker-->
      <Device Id="VideoDeviceAruco" Type="MmfVideo" AcquisitionRate="10" FrameSize="640 480" VideoFormat="YUY2" CaptureDeviceId="1">
         <DataSources>
            <DataSource Type="Video" Id="Video" PortUsImageOrientation="MF" ImageType="RGB_COLOR" />
         </DataSources>
         <OutputChannels>
            <OutputChannel Id="VideoStreamARUCO" VideoDataSourceId="Video" />
         </OutputChannels>
      </Device>
      <Device Id="TrackerDevice" Type="OpticalMarkerTracker" CameraCalibrationFile="camera_calibration.yml" ToolReferenceFrame="Tracker" TrackingMethod="OPTICAL_AND_DEPTH" MarkerDictionary="ARUCO_MIP_36h12">
         <DataSources>
            <DataSource Type="Tool" Id="Reference" MarkerId="2" MarkerSizeMm="50" BufferSize="150" />
            <DataSource Type="Tool" Id="Probe" MarkerId="3" MarkerSizeMm="50" BufferSize="150" />
            <DataSource Type="Tool" Id="Needle" MarkerId="4" MarkerSizeMm="50" BufferSize="150" />
         </DataSources>
         <InputChannels>
            <InputChannel Id="VideoStreamARUCO" />
         </InputChannels>
         <OutputChannels>
            <OutputChannel Id="TrackerStream">
               <DataSource Id="Reference" />
               <DataSource Id="Probe" />
               <DataSource Id="Needle" />
            </OutputChannel>
         </OutputChannels>
      </Device>
      <!-- For getting images from the US simulator -->
      <Device Id="VideoDevice" Type="UsSimulator" LocalTimeOffsetSec="0.0" AcquisitionRate="15">
         <DataSources>
            <DataSource Type="Video" Id="Video" PortUsImageOrientation="MF" />
         </DataSources>
         <InputChannels>
            <InputChannel Id="TrackerStream" />
         </InputChannels>
         <OutputChannels>
            <OutputChannel Id="USVideoStream" VideoDataSourceId="Video" />
         </OutputChannels>
         <vtkPlusUsSimulatorAlgo
           ImageCoordinateFrame="Image"
           ReferenceCoordinateFrame="Ras"
           IncomingIntensityMwPerCm2="300"
           BrightnessConversionGamma="0.2"
           BrighntessConversionOffset="30"
           NumberOfScanlines="128"
           NumberOfSamplesPerScanline="1000"
           NoiseAmplitude="5.0"
           NoiseFrequency="2.5 3.5 1"
           NoisePhase="50 20 0">
            <SpatialModel
              Name="Air"
              DensityKgPerM3="1.2"
              SoundVelocityMPerSec="343"
              AttenuationCoefficientDbPerCmMhz="100.0"
              BackscatterDiffuseReflectionCoefficient="0.1"
              SurfaceReflectionIntensityDecayDbPerMm="50" />
            <SpatialModel
              Name="GelBlock"
              ObjectCoordinateFrame="Ras"
              ModelFile="CubeModel.stl"
              ModelToObjectTransform=" 1 0 0 0    0 1 0 0     0 0 1 0    0 0 0 1 "
              DensityKgPerM3="910"
              SoundVelocityMPerSec="1540"
              AttenuationCoefficientDbPerCmMhz="3.0"
              BackscatterDiffuseReflectionCoefficient="0.1"
              SurfaceSpecularReflectionCoefficient="0.1"
              SurfaceDiffuseReflectionCoefficient="0.0"
              TransducerSpatialModelMaxOverlapMm="50" />
            <SpatialModel
              Name="Needle"
              ObjectCoordinateFrame="Needle"
              ModelFile="SimulatedUltrasound_NeedleModel_NeedleTip.stl"
              ModelToObjectTransform="                1 0 0 0                0 1 0 0                0 0 1 0                0 0 0 1" DensityKgPerM3="2000" SoundVelocityMPerSec="2000" AttenuationCoefficientDbPerCmMhz="8.0" BackscatterDiffuseReflectionCoefficient="0.2" SurfaceSpecularReflectionCoefficient="0.1" SurfaceDiffuseReflectionCoefficient="0.0" SurfaceReflectionIntensityDecayDbPerMm="5" />
            <RfProcessing>
               <ScanConversion TransducerName="Ultrasonix_L9-4/38" TransducerGeometry="LINEAR" ImagingDepthMm="60.0" TransducerWidthMm="40.0" OutputImageSizePixel="820 616" TransducerCenterPixel="410 0" OutputImageSpacingMmPerPixel="0.084 0.087" />
            </RfProcessing>
         </vtkPlusUsSimulatorAlgo>
      </Device>
      <Device Id="TrackedVideoDevice" Type="VirtualMixer">
         <InputChannels>
            <InputChannel Id="TrackerStream" />
            <InputChannel Id="USVideoStream" />
         </InputChannels>
         <OutputChannels>
            <OutputChannel Id="TrackedVideoStream" />
         </OutputChannels>
      </Device>
   </DataCollection>
   <CoordinateDefinitions>
      <Transform From="Reference" To="Ras" Matrix="
-0.010614 -0.998877 0.046169 -63.5844 
0.00695692 -0.0462443 -0.998906 -157.958 
0.999919 -0.0102812 0.00743994 -12.6337 
0 0 0 1 
                    " />
      <Transform From="Image" To="Probe" Matrix="
-0.429207 0.8979 -0.0977622 -135.371 
-0.899929 -0.415925 0.130897 49.3133 
0.0768706 0.144161 0.986564 93.99 
0 0 0 1 
                    " />
   </CoordinateDefinitions>
   <PlusOpenIGTLinkServer MaxNumberOfIgtlMessagesToSend="10" MaxTimeSpentWithProcessingMs="50" ListeningPort="18944" SendValidTransformsOnly="true" OutputChannelId="TrackedVideoStream">
      <DefaultClientInfo>
         <MessageTypes>
            <Message Type="IMAGE" />
            <Message Type="TRANSFORM" />
         </MessageTypes>
         <TransformNames>
            <Transform Name="NeedleToReference" />
            <Transform Name="ProbeToReference" />
            <Transform Name="NeedleToProbe" />
         </TransformNames>
         <ImageNames>
            <Image Name="Image" EmbeddedTransformToFrame="Image" />
         </ImageNames>
      </DefaultClientInfo>
   </PlusOpenIGTLinkServer>
</PlusConfiguration>
